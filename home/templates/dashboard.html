{% extends "layout.html" %}
{% block content %}
    <h1>Dashboard</h1>
    
    <div class="card">
        <h2>Current Savings</h2>
        <p>${{ '%.2f'|format(current_user.savings or 0) }}</p>
    </div>
    
    <div class="card">
        <h2>Account Analytics</h2>
        {% if account_analytics.rate_per_day %}
            <div class="analytics-details">
                <div class="analytics-row">
                    <span class="label">Current Rate:</span>
                    <span class="value">{{ '%.2f'|format(account_analytics.rate_per_day) }} / day</span>
                </div>
                <div class="analytics-row">
                    <span class="label">ETA to complete all goals:</span>
                    <span class="value">
                        {% if account_analytics.eta_ts %}
                            {{ account_analytics.eta_ts|timestamp_to_date }}
                        {% else %}
                            Can't generate ETA
                        {% endif %}
                    </span>
                </div>
            </div>
        {% else %}
            <p class="text-muted">No reliable rate could be inferred from recent transactions.</p>
        {% endif %}
    </div>
    <div class="card">
        <h3>Goal Analytics</h3>
        <div class="analytics-container">
            {% for goal_id, analytics in goal_analytics.items() %}
                {% set goal = goals|selectattr('id', 'equalto', goal_id)|first %}
                {% if goal %}
                <div class="analytics-item">
                    <h4>{{ goal.title }}</h4>
                    {% if analytics.remaining > 0 %}
                    <div class="analytics-details">
                        <div class="analytics-row">
                            <span class="label">Remaining:</span>
                            <span class="value">${{ '%.2f'|format(analytics.remaining) }}</span>
                        </div>
                        <div class="analytics-row">
                            <span class="label">Progress:</span>
                            <span class="value">{{ '%.2f'|format(analytics.progress_percent) }}%</span>
                        </div>
                        <div class="analytics-row">
                            <span class="label">ETA</span>
                            <span class="value">
                                {% if analytics.eta_ts %}
                                    {{ analytics.eta_ts|timestamp_to_date }}
                                {% else %}
                                    Can't generate ETA
                                {% endif %}
                            </span>
                        </div>
                        <div class="analytics-row">
                            {% if goal.deadline %}
                                <span class="label">Required Daily (until {{ goal.deadline.strftime('%Y-%m-%d') }})</span>
                            {% else %}
                                <span class="label">Required Daily (30 days default)</span>
                            {% endif %}
                            <span class="value">
                                {% if analytics.required_daily_30 %}
                                    ${{ '%.2f'|format(analytics.required_daily_30) }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% else %}
                    <div class="message">
                        <h4>Sufficient Funds</h4>
                        <p>You have enough funds to complete this goal.</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    
    <div class="card">
        <h3>Adjust Savings</h3>
        <form method="POST" action="{{ url_for('adjust_savings') }}">
            {{ adjust_form.hidden_tag() }}
            <div class="form-group">
                {{ adjust_form.operation.label }}
                {{ adjust_form.operation(class="form-control") }}
            </div>
            <div class="form-group">
                {{ adjust_form.amount.label }}
                {{ adjust_form.amount(class="form-control") }}
            </div>
            <div class="form-group">
                {{ adjust_form.description.label }}
                {{ adjust_form.description(class="form-control") }}
            </div>
            <button type="submit" class="btn">Adjust Savings</button>
        </form>
    </div>
    
    <div class="card">
        <h3>Set Savings Balance</h3>
        <form method="POST" action="{{ url_for('update_savings') }}">
            {{ savings_form.hidden_tag() }}
            <div class="form-group">
                {{ savings_form.savings.label }}
                {{ savings_form.savings(class="form-control") }}
            </div>
            {{ savings_form.submit(class="btn") }}
        </form>
    </div>
    
    <div class="card">
        <h3>Quick Actions</h3>
        <p>
            <a href="{{ url_for('goals') }}" class="btn">View Goals</a>
            <a href="{{ url_for('new_goal') }}" class="btn">Create Goal</a>
            <a href="{{ url_for('groups') }}" class="btn">View Groups</a>
        </p>
    </div>
    
    <style>
        .analytics-container {
            display: grid;
            gap: 1rem;
        }
        
        .analytics-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            background: #f9f9f9;
        }
        
        .analytics-details {
            margin-top: 0.5rem;
        }
        
        .analytics-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .analytics-row .label {
            font-weight: 500;
            color: #666;
        }
        
        .analytics-row .value {
            font-weight: 600;
        }
    </style>
{% endblock %}